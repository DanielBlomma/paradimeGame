<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Future Level - Payment Flow (Challenge)</title>
<style>
  body {
    margin: 0;
    background: #121212;
    color: #e0e0e0;
    font-family: "Segoe UI", sans-serif;
    display: flex;
    height: 100vh;
  }
  .program, .editor {
    flex: 1;
    padding: 20px;
    box-sizing: border-box;
  }
  .program {
    border-right: 1px solid #333;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }
  .editor {
    display: flex;
    flex-direction: column;
  }
  h3 { margin: 0 0 10px; }
  .task {
    background: #1e1e1e;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 6px;
    font-size: 13px;
    color: #bbb;
  }
  textarea {
    flex: 1;
    background: #1e1e1e;
    color: #00ff9c;
    border: none;
    padding: 10px;
    font-family: monospace;
    font-size: 13px;
    border-radius: 6px;
  }
  button {
    margin-top: 10px;
    padding: 10px;
    border: none;
    background: #00bcd4;
    color: #fff;
    font-weight: bold;
    border-radius: 6px;
    cursor: pointer;
  }
  button:hover { background: #00acc1; }

  /* Flowchart */
  .flow {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 95%;
    position: relative;
    gap: 60px;
  }
  .node {
    width: 200px;
    min-height: 120px;
    border-radius: 20px;
    text-align: center;
    font-weight: bold;
    padding: 15px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
  }
  .economy {
    background: linear-gradient(135deg, #1e88e5, #42a5f5);
    box-shadow: 0 0 15px #42a5f5aa;
    line-height: 90px;
  }
  .validator {
    background: linear-gradient(135deg, #fdd835, #fbc02d);
    color: #000;
    font-size: 13px;
    box-shadow: 0 0 15px #fbc02daa;
  }
  .endpoint {
    background: linear-gradient(135deg, #8e24aa, #ba68c8);
    box-shadow: 0 0 15px #ba68c8aa;
    line-height: 90px;
  }
  .bank {
    background: linear-gradient(135deg, #2e7d32, #66bb6a);
    box-shadow: 0 0 20px #66bb6aaa;
    font-size: 16px;
    padding-top: 20px;
  }

  /* Bubble */
  .bubble {
    width: 20px;
    height: 20px;
    background: #00ff9c;
    border-radius: 50%;
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    display: none;
    box-shadow: 0 0 10px #00ff9c;
    transition: left 1.5s ease-in-out;
  }
  .error { background: #ff5252 !important; box-shadow: 0 0 10px #ff5252; }

  /* Checklist */
  .checklist {
    text-align: left;
    font-size: 12px;
    margin-top: 5px;
  }
  .checklist div {
    opacity: 0;
    transition: opacity 0.5s;
  }
  .checklist div.show {
    opacity: 1;
  }
  .ok { color: green; }
  .fail { color: red; }

  /* Bank pulse */
  .bank-accepted {
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse {
    0% { box-shadow: 0 0 15px #66ff99; }
    50% { box-shadow: 0 0 35px #66ff99; }
    100% { box-shadow: 0 0 15px #66ff99; }
  }

  /* Data stream between API and Bank */
  .stream {
    position: absolute;
    top: 55%;
    left: 63%;
    width: 20%;
    height: 4px;
    overflow: hidden;
  }
  .dot {
    width: 6px;
    height: 6px;
    background: #00ff9c;
    border-radius: 50%;
    position: absolute;
    animation: flow 2s linear infinite;
  }
  @keyframes flow {
    from { left: -10px; }
    to { left: 100%; }
  }

  /* Fuskruta */
  .solution {
    background: #1e1e1e;
    border: 1px solid #444;
    padding: 10px;
    margin-top: 10px;
    display: none;
    font-size: 13px;
    color: #ccc;
  }
</style>
</head>
<body>

<!-- Left: Flow -->
<div class="program">
  <div class="flow">
    <div class="node economy">Ekonomisystem</div>
    <div class="node validator" id="validator">
      Validerings-AI<br><small>v√§ntar...</small>
      <div class="checklist" id="checklist"></div>
    </div>
    <div class="node endpoint">API / Endpoint</div>
    <div class="node bank" id="bank">Bank-AI</div>
    <div class="bubble" id="bubble"></div>
    <div class="stream" id="stream"></div>
  </div>
</div>

<!-- Right: Editor -->
<div class="editor">
  <h3>Utmaning</h3>
  <div class="task">
    üìå Skriv en prompt d√§r du:<br>
    ‚Ä¢ F√∂rklarar att du vill skicka en betalning (inkludera JSON)<br>
    ‚Ä¢ JSON m√•ste inneh√•lla <code>SenderIBAN</code>, <code>ReceiverIBAN</code>, <code>Amount</code> (tv√• decimaler), <code>Currency</code>, <code>Reference</code><br>
    ‚Ä¢ Betalningen ska skickas till <b>Bank A</b>, som kr√§ver att <code>ReceiverIBAN</code> = <code>SE7280000810340009783244</code>
  </div>
  <textarea id="prompt">Jag vill skicka min betalning: { }</textarea>
  <button onclick="sendPrompt()">Skicka prompt</button>
  <button onclick="showSolution()">Visa l√∂sning (fusk)</button>

  <div class="solution" id="solutionBox">
    ‚úÖ Exempel p√• korrekt prompt:<br><br>
    Jag vill skicka min betalning: {<br>
    &nbsp;&nbsp;"SenderIBAN": "SE3550000000054910000003",<br>
    &nbsp;&nbsp;"ReceiverIBAN": "SE7280000810340009783244",<br>
    &nbsp;&nbsp;"Amount": "1095.00",<br>
    &nbsp;&nbsp;"Currency": "SEK",<br>
    &nbsp;&nbsp;"Reference": "Faktura 930421"<br>
    } till validering och sedan till Bank A
  </div>
</div>

<script>
function sendPrompt() {
  let text = document.getElementById("prompt").value;
  let bubble = document.getElementById("bubble");
  let checklist = document.getElementById("checklist");
  let validatorNode = document.getElementById("validator");
  let bankNode = document.getElementById("bank");
  let stream = document.getElementById("stream");

  // Reset
  bubble.style.display = "block";
  bubble.style.left = "5%";
  checklist.innerHTML = "";
  validatorNode.querySelector("small").innerText = "validerar...";
  bankNode.innerText = "Bank-AI";
  bankNode.classList.remove("bank-accepted");
  stream.innerHTML = "";

  // Step 1: Move to validator
  setTimeout(() => {
    bubble.style.left = "35%";

    // Run validation
    validateData(text, (ok) => {
      if (ok) {
        validatorNode.querySelector("small").innerText = "OK";

        // Step 2: Move to API
        setTimeout(() => {
          bubble.style.left = "60%";

          // Start stream
          startDataStream(stream);

          // Step 3: Move to Bank
          setTimeout(() => {
            bubble.style.left = "85%";
            stream.innerHTML = "";
            if (ok) {
              bankNode.innerText = "Bank-AI ‚úÖ\nACCEPTED";
              bankNode.classList.add("bank-accepted");

              setTimeout(() => {
                if (window.parent) {
                  window.parent.postMessage({ action: "nextLevel" }, "*");
                }
              }, 2000);
            }
          }, 2500);

        }, 1000);

      } else {
        validatorNode.querySelector("small").innerText = "fel i data";
        bankNode.innerText = "Bank-AI ‚ùå (Ingen betalning)";
        bubble.classList.add("error");
      }
    });

  }, 500);
}

function validateData(text, callback) {
  let errors = [];
  let jsonMatch = text.match(/{[\s\S]*}/);
  let data = null;

  if (!jsonMatch) {
    errors.push("Ingen JSON hittades");
  } else {
    try {
      data = JSON.parse(jsonMatch[0]);
    } catch(e) {
      errors.push("Ogiltigt JSON-format");
    }
  }

  let checks = [];
  if (data) {
    checks.push({field:"SenderIBAN", ok:/^SE\d{15,}$/.test(data.SenderIBAN)});
    checks.push({field:"ReceiverIBAN", ok:data.ReceiverIBAN==="SE7280000810340009783244"});
    checks.push({field:"Amount", ok:/^\d+\.\d{2}$/.test(data.Amount||"")});
    checks.push({field:"Currency", ok:["SEK","EUR","USD"].includes(data.Currency)});
    checks.push({field:"Reference", ok:!!data.Reference});
  }

  let checklist = document.getElementById("checklist");
  checks.forEach((c,i)=>{
    setTimeout(()=>{
      let div=document.createElement("div");
      div.classList.add("show");
      div.classList.add(c.ok?"ok":"fail");
      div.innerText=(c.ok?"‚úÖ ":"‚ùå ")+c.field;
      checklist.appendChild(div);
      if (i===checks.length-1) {
        setTimeout(()=>callback(checks.every(c=>c.ok)),500);
      }

      
    }, i*500);
  });

  if (checks.length===0) {
    setTimeout(()=>callback(false),500);
  }
}

function startDataStream(stream) {
  for (let i=0;i<5;i++) {
    let dot=document.createElement("div");
    dot.className="dot";
    dot.style.top="0px";
    dot.style.animationDelay=(i*0.4)+"s";
    stream.appendChild(dot);
  }
}

function showSolution() {
  document.getElementById("solutionBox").style.display = "block";
}
</script>

</body>
</html>
